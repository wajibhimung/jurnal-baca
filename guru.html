<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Guru - Jurnal Baca</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-color: #6a11cb; --secondary-color: #2575fc; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); 
            color: #333; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
            /* Memberi ruang untuk navbar fixed */
            padding-top: 75px; 
        }
        main {
            flex: 1 0 auto; /* Memastikan main content mengisi ruang yang tersedia */
        }
        .main-content { padding-top: 40px; padding-bottom: 40px; }
        .loader-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1060; }
        nav.navbar { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        .data-card { background: rgba(255, 255, 255, 0.95); border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .nav-pills .nav-link { color: white; }
        .nav-pills .nav-link.active { background-color: white; color: var(--primary-color); font-weight: 600; }
        .modal-content { background: #fff; }
        .jurnal-detail-mood { font-size: 3rem; }
        .jurnal-detail-ringkasan { white-space: pre-wrap; background-color: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;}
        .footer { background: rgba(0, 0, 0, 0.2); color: rgba(255, 255, 255, 0.7); padding: 1rem 0; flex-shrink: 0; }
    </style>
</head>
<body>
    <div id="loader" class="loader-wrapper"><div class="spinner-border text-light" role="status"></div></div>
    
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-chalkboard-teacher"></i> Dasbor Guru</a>
            <div class="d-flex align-items-center"><span class="navbar-text me-3" id="teacherName"></span><button class="btn btn-outline-light" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button></div>
        </div>
    </nav>

    <main class="container-fluid main-content">
        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="stats-tab" data-bs-toggle="pill" data-bs-target="#pills-stats" type="button">Statistik</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="jurnal-kelas-tab" data-bs-toggle="pill" data-bs-target="#pills-jurnal-kelas" type="button">Jurnal per Kelas</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="semua-jurnal-tab" data-bs-toggle="pill" data-bs-target="#pills-semua-jurnal" type="button">Semua Jurnal</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="data-siswa-tab" data-bs-toggle="pill" data-bs-target="#pills-siswa" type="button">Data Siswa</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="data-kelas-tab" data-bs-toggle="pill" data-bs-target="#pills-kelas" type="button">Data Kelas</button></li>
        </ul>
        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-stats" role="tabpanel">
                <div class="row">
                    <div class="col-lg-7 mb-4"><div class="card data-card h-100"><div class="card-body"><h5 class="card-title">Siswa Paling Aktif (Halaman Dibaca)</h5><canvas id="studentChart"></canvas></div></div></div>
                    <div class="col-lg-5 mb-4"><div class="card data-card h-100"><div class="card-body"><h5 class="card-title">Tabel Peringkat</h5><div class="table-responsive"><table class="table table-striped table-hover"><thead><tr><th>Peringkat</th><th>Nama Siswa</th><th>Buku</th><th>Total Halaman</th></tr></thead><tbody id="leaderboardTable"></tbody></table></div></div></div></div>
                </div>
            </div>
            <div class="tab-pane fade" id="pills-jurnal-kelas" role="tabpanel"><div class="card data-card"><div class="card-body"><h5 class="card-title">Laporan Aktivitas Membaca per Kelas</h5><div class="row g-3 align-items-end mb-4 border-bottom pb-3"><div class="col-md-5"><label for="selectKelasForReport" class="form-label">Pilih Kelas:</label><select id="selectKelasForReport" class="form-select"></select></div><div class="col-md-3"><label for="startDate" class="form-label">Tanggal Mulai:</label><input type="date" id="startDate" class="form-control"></div><div class="col-md-3"><label for="endDate" class="form-label">Tanggal Akhir:</label><input type="date" id="endDate" class="form-control"></div><div class="col-md-1"><button id="resetDateFilter" class="btn btn-outline-secondary w-100" title="Reset Filter"><i class="fas fa-times"></i></button></div></div><div id="classReportContainer" class="d-none"><h6 id="classReportTitle"></h6><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Nama Siswa</th><th>Buku Dibaca</th><th>Total Halaman</th><th>Aksi</th></tr></thead><tbody id="classReportTable"></tbody></table></div></div></div></div></div>
            <div class="tab-pane fade" id="pills-semua-jurnal" role="tabpanel"><div class="card data-card"><div class="card-body"><div class="d-flex justify-content-between align-items-center mb-3"><h5 class="card-title">Daftar Semua Jurnal</h5><select id="filterKelasJurnal" class="form-select w-auto"><option value="all">Semua Kelas</option></select></div><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Tanggal</th><th>Siswa</th><th>Kelas</th><th>Judul Buku</th><th>Aksi</th></tr></thead><tbody id="allJournalsTable"></tbody></table></div></div></div></div>
            <div class="tab-pane fade" id="pills-siswa" role="tabpanel"><div class="card data-card"><div class="card-body"><button class="btn btn-success mb-3" id="addStudentBtn"><i class="fas fa-user-plus"></i> Tambah Siswa</button><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Nama</th><th>Email</th><th>Kelas</th><th>Aksi</th></tr></thead><tbody id="allStudentsTable"></tbody></table></div></div></div></div>
            <div class="tab-pane fade" id="pills-kelas" role="tabpanel"><div class="card data-card"><div class="card-body"><div class="input-group mb-3"><input type="text" id="newClassName" class="form-control" placeholder="Nama Kelas Baru"><button class="btn btn-success" id="addClassBtn"><i class="fas fa-plus"></i> Tambah</button></div><ul id="classList" class="list-group"></ul></div></div></div>
        </div>
    </main>
    <footer class="footer text-center p-3">
         Dibuat dengan <i class="fas fa-heart text-danger"></i> untuk Kelas TKJ SMKN 1 Telagasari © 2025
    </footer>
    
    <!-- MODALS (tidak berubah) -->
    <div class="modal fade" id="studentModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="studentModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="studentForm"><input type="hidden" id="studentId"><div class="mb-3"><label class="form-label">Nama Siswa</label><input type="text" id="studentNameInput" class="form-control" required></div><div class="mb-3"><label class="form-label">Email</label><input type="email" id="studentEmailInput" class="form-control" required></div><div class="mb-3"><label class="form-label">Password</label><input type="text" id="studentPasswordInput" class="form-control" required></div><div class="mb-3"><label class="form-label">Kelas</label><select id="studentClassInput" class="form-select" required></select></div><button type="submit" class="btn btn-primary w-100">Simpan</button></form></div></div></div></div>
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Konfirmasi Hapus</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p id="confirmMessage">Apakah Anda yakin?</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-danger" id="confirmDeleteBtn">Hapus</button></div></div></div></div>
    <div class="modal fade" id="jurnalDetailModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="jurnalDetailTitle">Detail Jurnal</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="jurnalDetailBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxHVip9ojPg5rHfua-rql-L3fGoEvKW5slm8QKkbCof3llSolsYUvBO_h0jTohBFG-unA/exec";
    let currentUser = null, teacherData = null, studentChart = null, deleteInfo = { type: null, id: null };
    const loader = document.getElementById('loader');
    const myStudentModal = new bootstrap.Modal(document.getElementById('studentModal'));
    const myConfirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
    const myJurnalDetailModal = new bootstrap.Modal(document.getElementById('jurnalDetailModal'));
    
    document.addEventListener('DOMContentLoaded', () => {
        const userJson = sessionStorage.getItem('currentUser');
        if (!userJson) { window.location.href = 'index.html'; return; }
        currentUser = JSON.parse(userJson);
        if (currentUser.role !== 'guru') { logout(); return; }
        document.getElementById('teacherName').textContent = `Selamat datang, ${currentUser.user.nama}!`;
        setupEventListeners();
        loadTeacherData();
    });

    function setupEventListeners() {
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('addClassBtn').addEventListener('click', addClass);
        document.getElementById('addStudentBtn').addEventListener('click', showAddStudentModal);
        document.getElementById('studentForm').addEventListener('submit', handleStudentForm);
        document.getElementById('confirmDeleteBtn').addEventListener('click', executeDelete);
        document.getElementById('selectKelasForReport').addEventListener('change', showClassReport);
        document.getElementById('startDate').addEventListener('change', showClassReport);
        document.getElementById('endDate').addEventListener('change', showClassReport);
        document.getElementById('resetDateFilter').addEventListener('click', () => {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            showClassReport();
        });
        const tabElements = document.querySelectorAll('#pills-tab .nav-link');
        tabElements.forEach(tab => {
            tab.addEventListener('shown.bs.tab', (event) => {
                const targetId = event.target.id;
                if (!event.target.getAttribute('data-rendered')) {
                    if (targetId === 'jurnal-kelas-tab') renderJurnalPerKelasTab();
                    else if (targetId === 'semua-jurnal-tab') renderSemuaJurnal();
                    else if (targetId === 'data-siswa-tab') renderStudentList();
                    else if (targetId === 'data-kelas-tab') renderClassList();
                    event.target.setAttribute('data-rendered', 'true');
                }
            });
        });
    }

    function logout() { sessionStorage.removeItem('currentUser'); window.location.href = 'index.html'; }
    async function apiCall(action, data = {}) { loader.style.display = 'flex'; try { const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action, data }), redirect: "follow" }); const result = await response.json(); if (result.status === 'success') { return result.data; } else { throw new Error(result.message || 'Terjadi kesalahan.'); } } catch (error) { console.error("API Call Error:", error); alert("Error: " + error.message); return null; } finally { loader.style.display = 'none'; } }
    async function loadTeacherData() { const data = await apiCall('getTeacherDashboardData'); if(data) { teacherData = data; renderStats(); document.getElementById('stats-tab').setAttribute('data-rendered', 'true'); } }
    function parseDate(dateString) { if (!dateString) return null; const parts = dateString.split('/'); return new Date(parts[2], parts[1] - 1, parts[0]); }
    
    // ▼▼▼ FUNGSI INI SUDAH DIPERBAIKI (FINAL) ▼▼▼
    function renderStats() {
        if (!teacherData) return;
        const studentStats = {};
        teacherData.journals.forEach(j => {
            if (!j.namaSiswa) return; 
            const studentName = j.namaSiswa;
            if (!studentStats[studentName]) { studentStats[studentName] = { totalPages: 0, uniqueBooks: new Set() }; }
            studentStats[studentName].totalPages += (parseInt(j.halaman) || 0);
            if(j.judulBuku && j.judulBuku.trim() !== '') { studentStats[studentName].uniqueBooks.add(j.judulBuku.trim()); }
        });
        const rankedList = Object.keys(studentStats).map(name => ({ name: name, totalPages: studentStats[name].totalPages, bookCount: studentStats[name].uniqueBooks.size }));
        rankedList.sort((a, b) => b.totalPages - a.totalPages);
        
        const top10 = rankedList.slice(0, 10);
        const labels = top10.map(item => item.name); 
        const data = top10.map(item => item.totalPages);
        const ctx = document.getElementById('studentChart').getContext('2d');
        if (studentChart) studentChart.destroy();
        studentChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: '# Halaman Dibaca', data, backgroundColor: 'rgba(75, 192, 192, 0.5)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true } }, responsive: true } });
        
        const tableBody = document.getElementById('leaderboardTable');
        tableBody.innerHTML = '';
        rankedList.forEach((student, index) => {
            tableBody.innerHTML += `<tr><td>${index + 1}</td><td>${student.name}</td><td>${student.bookCount}</td><td>${student.totalPages}</td></tr>`;
        });
    }

    // ▼▼▼ FUNGSI INI JUGA DIPERBAIKI (FINAL) ▼▼▼
    function showClassReport() {
        if (!teacherData) return;
        const selectedClass = document.getElementById('selectKelasForReport').value;
        const container = document.getElementById('classReportContainer');
        if (!selectedClass) { container.classList.add('d-none'); return; }
        container.classList.remove('d-none');
        document.getElementById('classReportTitle').textContent = `Menampilkan Laporan untuk Kelas: ${selectedClass}`;
        
        const startDateString = document.getElementById('startDate').value;
        const endDateString = document.getElementById('endDate').value;
        
        let dateFilteredJournals = teacherData.journals;
        if (startDateString && endDateString) {
            const startDate = new Date(startDateString);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateString);
            endDate.setHours(23, 59, 59, 999); 
            dateFilteredJournals = teacherData.journals.filter(j => {
                const journalDate = parseDate(j.tanggalBaca);
                return journalDate && journalDate >= startDate && journalDate <= endDate;
            });
        }
        
        const studentsInClass = teacherData.students.filter(s => s.kelas === selectedClass);
        const reportData = studentsInClass.map(student => {
            const studentJournalsInClass = dateFilteredJournals.filter(j => j.namaSiswa === student.nama && j.kelasSiswa === selectedClass);
            // Perbaikan bug trim: filter dulu sebelum map
            const uniqueBooks = new Set(studentJournalsInClass.map(j => j.judulBuku).filter(Boolean).map(title => title.trim()));
            const totalHalaman = studentJournalsInClass.reduce((sum, j) => sum + (parseInt(j.halaman) || 0), 0);
            return { nama: student.nama, totalBuku: uniqueBooks.size, totalHalaman };
        });
        
        const tableBody = document.getElementById('classReportTable');
        tableBody.innerHTML = '';
        if(reportData.every(d => d.totalBuku === 0 && d.totalHalaman === 0)) { 
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center">Tidak ada data jurnal untuk filter yang dipilih.</td></tr>`; 
            return; 
        }
        reportData.sort((a,b) => b.totalHalaman - a.totalHalaman).forEach(data => { 
            tableBody.innerHTML += `<tr><td>${data.nama}</td><td>${data.totalBuku}</td><td>${data.totalHalaman}</td><td><button class="btn btn-sm btn-outline-primary" onclick="showStudentJournals('${data.nama}')">Lihat Jurnal</button></td></tr>`; 
        });
    }

    function showJurnalDetail(idJurnal) {
        const jurnal = teacherData.journals.find(j => j.idJurnal === idJurnal);
        if(!jurnal) return;
        document.getElementById('jurnalDetailTitle').textContent = 'Detail Jurnal'; 
        const detailBody = document.getElementById('jurnalDetailBody');
        detailBody.innerHTML = `<div class="row"><div class="col-md-9"><h3>${jurnal.judulBuku}</h3><p class="text-muted">oleh <strong>${jurnal.penulis}</strong></p><hr><p><strong>Dibaca oleh:</strong> ${jurnal.namaSiswa} (${jurnal.kelasSiswa})</p><p><strong>Tanggal Baca:</strong> ${jurnal.tanggalBaca}</p><p><strong>Halaman Dibaca:</strong> ${jurnal.halaman}</p></div><div class="col-md-3 text-center"><p><strong>Mood:</strong></p><div class="jurnal-detail-mood">${jurnal.mood || 'N/A'}</div></div></div><div class="mt-3"><h5>Ringkasan:</h5><div class="jurnal-detail-ringkasan">${jurnal.ringkasan}</div></div>`;
        myJurnalDetailModal.show();
    }
    
    // Fungsi lainnya tidak berubah
    function renderSemuaJurnal() { if (!teacherData) return; const tableBody = document.getElementById('allJournalsTable'); tableBody.innerHTML = ''; const filterDropdown = document.getElementById('filterKelasJurnal'); const filterClass = filterDropdown.value || 'all'; const filteredJournals = (filterClass === 'all') ? teacherData.journals : teacherData.journals.filter(j => j.kelasSiswa === filterClass); filteredJournals.forEach(j => { tableBody.innerHTML += `<tr><td>${j.tanggalBaca}</td><td>${j.namaSiswa}</td><td>${j.kelasSiswa}</td><td>${j.judulBuku}</td><td><button class="btn btn-sm btn-info" onclick="showJurnalDetail('${j.idJurnal}')"><i class="fas fa-eye"></i></button> <button class="btn btn-sm btn-danger" onclick="showConfirmDeleteModal('journal', '${j.idJurnal}')"><i class="fas fa-trash"></i></button></td></tr>`; }); if (!filterDropdown.getAttribute('data-initialized')) { filterDropdown.innerHTML = '<option value="all">Semua Kelas</option>'; teacherData.classes.forEach(c => { filterDropdown.innerHTML += `<option value="${c}">${c}</option>`; }); filterDropdown.onchange = () => renderSemuaJurnal(); filterDropdown.setAttribute('data-initialized', 'true'); } }
    function renderJurnalPerKelasTab() { if (!teacherData) return; const select = document.getElementById('selectKelasForReport'); select.innerHTML = '<option value="">-- Pilih Kelas --</option>'; teacherData.classes.forEach(c => { select.innerHTML += `<option value="${c}">${c}</option>`; }); document.getElementById('classReportContainer').classList.add('d-none'); }
    function renderStudentList() { if (!teacherData) return; const tableBody = document.getElementById('allStudentsTable'); tableBody.innerHTML = ''; teacherData.students.forEach(s => { tableBody.innerHTML += `<tr><td>${s.nama}</td><td>${s.email}</td><td>${s.kelas}</td><td><button class="btn btn-sm btn-warning" onclick="editStudent('${s.idSiswa}')"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-danger" onclick="showConfirmDeleteModal('student', '${s.idSiswa}', '${s.nama}')"><i class="fas fa-trash"></i></button></td></tr>`; }); }
    function renderClassList() { if (!teacherData) return; const list = document.getElementById('classList'); list.innerHTML = ''; teacherData.classes.forEach(c => { list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">${c}<button class="btn btn-sm btn-outline-danger" onclick="showConfirmDeleteModal('class', '${c}')"><i class="fas fa-trash"></i></button></li>`; }); }
    async function refreshDataAndRerender() { const data = await apiCall('getTeacherDashboardData'); if(data) { teacherData = data; document.querySelectorAll('#pills-tab .nav-link').forEach(tab => tab.removeAttribute('data-rendered')); const activeTab = document.querySelector('#pills-tab .nav-link.active'); if (activeTab) { const event = new Event('shown.bs.tab'); activeTab.dispatchEvent(event); activeTab.setAttribute('data-rendered', 'true'); } } }
    function showStudentJournals(studentName) { const startDateString = document.getElementById('startDate').value; const endDateString = document.getElementById('endDate').value; let studentJournals = teacherData.journals.filter(j => j.namaSiswa === studentName); if (startDateString && endDateString) { const startDate = new Date(startDateString); startDate.setHours(0, 0, 0, 0); const endDate = new Date(endDateString); endDate.setHours(23, 59, 59, 999); studentJournals = studentJournals.filter(j => { const journalDate = parseDate(j.tanggalBaca); return journalDate && journalDate >= startDate && journalDate <= endDate; }); } document.getElementById('jurnalDetailTitle').textContent = `Jurnal oleh ${studentName}`; let detailHTML = `<h5>Total Entri: ${studentJournals.length}</h5><hr>`; if(studentJournals.length === 0) { detailHTML += '<p>Siswa ini tidak memiliki jurnal dalam rentang tanggal yang dipilih.</p>'; } else { studentJournals.sort((a, b) => parseDate(b.tanggalBaca) - parseDate(a.tanggalBaca)); studentJournals.forEach(j => { detailHTML += `<div class="mb-3 p-2 border rounded"><strong>${j.judulBuku}</strong><br><small>${j.tanggalBaca} - ${j.halaman} halaman</small></div>`; }); } document.getElementById('jurnalDetailBody').innerHTML = detailHTML; myJurnalDetailModal.show(); }
    function showConfirmDeleteModal(type, id, name = '') { deleteInfo = { type, id }; const message = document.getElementById('confirmMessage'); if (type === 'class') message.textContent = `Yakin ingin menghapus kelas "${id}"?`; else if (type === 'student') message.textContent = `Yakin ingin menghapus siswa "${name}"?`; else if (type === 'journal') message.textContent = `Yakin ingin menghapus jurnal ini?`; myConfirmDeleteModal.show(); }
    async function executeDelete() { myConfirmDeleteModal.hide(); let action = '', payload = {}; if (deleteInfo.type === 'class') { action = 'deleteClass'; payload = { className: deleteInfo.id }; } else if (deleteInfo.type === 'student') { action = 'deleteStudent'; payload = { idSiswa: deleteInfo.id }; } else if (deleteInfo.type === 'journal') { action = 'deleteJournal'; payload = { idJurnal: deleteInfo.id }; } if (action) { await apiCall(action, payload); await refreshDataAndRerender(); } }
    async function addClass() { const className = document.getElementById('newClassName').value.trim(); if(className) { await apiCall('addClass', { className }); await refreshDataAndRerender(); document.getElementById('newClassName').value = ''; } }
    async function handleStudentForm(e) { e.preventDefault(); const studentId = document.getElementById('studentId').value; const action = studentId ? 'updateStudent' : 'addStudent'; const studentData = { idSiswa: studentId, nama: document.getElementById('studentNameInput').value, email: document.getElementById('studentEmailInput').value, password: document.getElementById('studentPasswordInput').value, kelas: document.getElementById('studentClassInput').value, }; const result = await apiCall(action, studentData); if (result) { myStudentModal.hide(); await refreshDataAndRerender(); } }
    function showAddStudentModal() { document.getElementById('studentForm').reset(); document.getElementById('studentId').value = ''; document.getElementById('studentModalTitle').textContent = 'Tambah Siswa Baru'; populateClassDropdown(); myStudentModal.show(); }
    function editStudent(idSiswa) { const student = teacherData.students.find(s => s.idSiswa === idSiswa); if(student) { document.getElementById('studentForm').reset(); document.getElementById('studentId').value = student.idSiswa; document.getElementById('studentNameInput').value = student.nama; document.getElementById('studentEmailInput').value = student.email; document.getElementById('studentPasswordInput').value = student.password; populateClassDropdown(student.kelas); document.getElementById('studentModalTitle').textContent = 'Edit Data Siswa'; myStudentModal.show(); } }
    function populateClassDropdown(selectedClass = '') { const select = document.getElementById('studentClassInput'); select.innerHTML = '<option value="">Pilih Kelas</option>'; teacherData.classes.forEach(c => { const selected = (c === selectedClass) ? 'selected' : ''; select.innerHTML += `<option value="${c}" ${selected}>${c}</option>`; }); }
</script>
</body>
</html>