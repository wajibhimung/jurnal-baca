<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Kupon - Dasbor Guru</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding-top: 75px;
        }

        .main-content {
            flex-grow: 1;
            padding-top: 20px;
            padding-bottom: 40px;
        }

        .loader-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .toast-container {
            z-index: 10000;
        }

        nav.navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .navbar-brand { font-weight: 600; }

        .tabs-container {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
        }

        .nav-pills .nav-link {
            color: white;
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-weight: 500;
        }

        .nav-pills .nav-link.active {
            background-color: white;
            color: var(--primary-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: 600;
        }

        .data-card, .student-info-panel {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 1.5rem;
            height: 100%;
        }

        .student-info-panel {
            margin-bottom: 2rem;
            height: auto;
        }
        .student-info-panel .display-4 { 
            font-weight: 700; 
            color: var(--primary-color);
        }

        .item-card-long {
            display: flex;
            align-items: center;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            padding: 1rem;
            position: relative;
        }

        .item-card-long:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }
        .item-card-long .icon-container {
            font-size: 2.2rem;
            color: var(--secondary-color);
            width: 60px;
            flex-shrink: 0;
            display: grid;
            place-items: center;
        }
        .item-card-long .content-container { flex-grow: 1; padding-left: 1.25rem; }
        .item-card-long .item-title { font-weight: 600; margin-bottom: 0.1rem; color: #333; }
        .item-card-long .item-description { font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; }
        .item-card-long .item-footer { display: flex; justify-content: space-between; align-items: center; }
        .item-card-long .item-cost { font-weight: 600; font-size: 1.1rem; color: var(--primary-color); }

        .disabled-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(2px);
            display: flex; justify-content: center; align-items: center;
            color: #333; font-weight: 600; text-align: center;
            border-radius: 12px;
        }
        
        .footer {
            background: rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.7);
            padding: 1rem 0;
            text-align: center;
            font-size: 0.9rem;
            margin-top: auto;
            flex-shrink: 0;
        }
        .footer a {
            color: #fff;
            text-decoration: none;
            font-weight: 600;
        }
        .footer a:hover {
            text-decoration: underline;
        }

        .pagination .page-link { background-color: #fff; border-color: #ddd; color: var(--primary-color); }
        .pagination .page-item.active .page-link { background-color: var(--primary-color); border-color: var(--primary-color); color: #fff; }
        .pagination .page-item.disabled .page-link { color: #6c757d; background-color: #e9ecef; }
        .pagination-sm { margin-bottom: 0; }
        
        .list-group-item.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .text-primary {
            color: var(--primary-color) !important;
        }
    </style>
</head>
<body>
    <div id="loader" class="loader-wrapper"><div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status"></div></div>
    
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"><div class="toast-header"><i class="fas rounded me-2"></i><strong class="me-auto" id="toastTitle"></strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button></div><div class="toast-body" id="toastBody"></div></div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="guru.html"><i class="fas fa-award me-2"></i>Dasbor Kupon Guru</a>
            <div class="d-flex align-items-center">
                <span class="navbar-text me-3" id="teacherName"></span>
                <a href="guru.html" class="btn btn-outline-light btn-sm me-2">Dasbor Utama</a>
                <button class="btn btn-outline-light" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>
        
    <main class="container-fluid main-content">
        <div class="tabs-container mb-4">
             <ul class="nav nav-pills nav-fill" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-pemberian"><i class="fas fa-plus-circle me-1"></i> Berikan Kupon</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-penukaran"><i class="fas fa-gift me-1"></i> Tukar Hadiah</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-perkelas"><i class="fas fa-users me-1"></i> Kupon per Kelas</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-manajemen"><i class="fas fa-cogs me-1"></i> Manajemen</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-riwayat"><i class="fas fa-history me-1"></i> Riwayat</button></li>
            </ul>
        </div>

        <div class="tab-content" id="pills-tabContent">
            <!-- TAB BERIKAN KUPON -->
            <div class="tab-pane fade show active" id="pills-pemberian" role="tabpanel">
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="data-card">
                            <h5 class="mb-3 fw-bold">1. Pilih Siswa</h5>
                            <input type="text" id="studentSearchGive" class="form-control mb-2" placeholder="Cari nama siswa...">
                            <div class="list-group" id="studentListGive" style="max-height: 600px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div id="actionAreaGive">
                            <div class="data-card d-flex justify-content-center align-items-center" style="min-height: 680px;">
                                <div class="text-center text-muted">
                                    <i class="fas fa-user-check fa-4x mb-3 opacity-50" style="color: var(--primary-color);"></i>
                                    <h5 class="fw-light">Pilih siswa untuk memberikan kupon.</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB TUKAR HADIAH -->
            <div class="tab-pane fade" id="pills-penukaran" role="tabpanel">
                 <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="data-card">
                            <h5 class="mb-3 fw-bold">1. Pilih Siswa</h5>
                            <input type="text" id="studentSearchRedeem" class="form-control mb-2" placeholder="Cari nama siswa...">
                            <div class="list-group" id="studentListRedeem" style="max-height: 600px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div id="actionAreaRedeem">
                             <div class="data-card d-flex justify-content-center align-items-center" style="min-height: 680px;">
                                <div class="text-center text-muted">
                                    <i class="fas fa-shopping-cart fa-4x mb-3 opacity-50" style="color: var(--primary-color);"></i>
                                    <h5 class="fw-light">Pilih siswa untuk melihat katalog hadiah.</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB KUPON PER KELAS -->
            <div class="tab-pane fade" id="pills-perkelas" role="tabpanel">
                <div class="data-card">
                    <div class="row align-items-center mb-3">
                        <div class="col-md-6"><h4 class="mb-md-0 mb-2 fw-bold">Saldo Kupon Siswa</h4></div>
                        <div class="col-md-6"><select id="classFilter" class="form-select"></select></div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead><tr><th>No</th><th>Nama Siswa</th><th>Kelas</th><th class="text-center">Jumlah Kupon</th></tr></thead>
                            <tbody id="classCouponTable"></tbody>
                        </table>
                    </div>
                    <nav id="classCouponPagination" class="mt-3 d-flex justify-content-end"></nav>
                </div>
            </div>
            
            <!-- TAB MANAJEMEN -->
            <div class="tab-pane fade" id="pills-manajemen" role="tabpanel">
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="data-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0 fw-bold"><i class="fas fa-ticket-alt me-2 text-primary"></i>Tipe Kupon</h5>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#couponTypeModal"><i class="fas fa-plus"></i> Tambah</button>
                            </div>
                            <div class="table-responsive"><table class="table table-hover"><thead><tr><th>Capaian</th><th>Poin</th><th>Aksi</th></tr></thead><tbody id="couponTypesTable"></tbody></table></div>
                            <nav id="couponTypesPagination" class="mt-3 d-flex justify-content-end"></nav>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="data-card">
                             <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0 fw-bold"><i class="fas fa-gift me-2 text-primary"></i>Hadiah</h5>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#prizeModal"><i class="fas fa-plus"></i> Tambah</button>
                            </div>
                            <div class="table-responsive"><table class="table table-hover"><thead><tr><th>Hadiah</th><th>Biaya</th><th>Aksi</th></tr></thead><tbody id="prizesTable"></tbody></table></div>
                            <nav id="prizesPagination" class="mt-3 d-flex justify-content-end"></nav>
                        </div>
                    </div>
                </div>
            </div>
            
             <!-- TAB RIWAYAT -->
             <div class="tab-pane fade" id="pills-riwayat" role="tabpanel">
                 <div class="data-card">
                    <div class="row mb-3 gx-2 gy-2 justify-content-between align-items-center">
                        <div class="col-md-auto"><h5 class="card-title mb-0 fw-bold">Riwayat Penukaran</h5></div>
                        <div class="col-md-5 col-lg-4"><input type="search" class="form-control form-control-sm" id="historySearch" placeholder="Cari nama atau hadiah..."></div>
                    </div>
                    <div class="table-responsive"><table class="table table-hover"><thead><tr><th>Tanggal</th><th>Siswa</th><th>Hadiah</th><th class="text-center">Biaya</th></tr></thead><tbody id="historyTableBody"></tbody></table></div>
                    <nav id="historyPagination" class="mt-3 d-flex justify-content-end"></nav>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer text-center p-3">
        Dibuat dengan <i class="fas fa-heart text-danger"></i> untuk Kelas TKJ SMKN 1 Telagasari © <a href="guru.html">2025</a>
    </footer>

    <!-- Modals -->
    <div class="modal fade" id="couponTypeModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Manajemen Tipe Kupon</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="couponTypeForm"><div class="mb-3"><label class="form-label">Capaian</label><input type="text" id="capaian" class="form-control" required></div><div class="mb-3"><label class="form-label">Jumlah Kupon Diberikan</label><input type="number" id="jumlahKupon" class="form-control" min="1" required></div><div class="mb-3"><label class="form-label">Deskripsi</label><textarea id="deskripsiKupon" class="form-control" rows="3"></textarea></div><button type="submit" class="btn btn-primary w-100">Simpan</button></form></div></div></div></div>
    <div class="modal fade" id="prizeModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Manajemen Hadiah</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="prizeForm"><div class="mb-3"><label class="form-label">Nama Hadiah</label><input type="text" id="namaHadiah" class="form-control" required></div><div class="mb-3"><label class="form-label">Kupon Dibutuhkan</label><input type="number" id="kuponDibutuhkan" class="form-control" min="1" required></div><div class="mb-3"><label class="form-label">Deskripsi</label><textarea id="deskripsiHadiah" class="form-control" rows="3"></textarea></div><button type="submit" class="btn btn-primary w-100">Simpan</button></form></div></div></div></div>
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="confirmTitle">Konfirmasi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p id="confirmMessageText"></p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-danger" id="confirmDeleteBtn">Hapus</button></div></div></div></div>
    <div class="modal fade" id="confirmRedeemModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="confirmRedeemTitle">Konfirmasi Penukaran</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="confirmRedeemBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="confirmRedeemBtn">Tukar Sekarang</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // BAGIAN SCRIPT TETAP SAMA SEPERTI ASLINYA
    const API_URL = "https://script.google.com/macros/s/AKfycbxHVip9ojPg5rHfua-rql-L3fGoEvKW5slm8QKkbCof3llSolsYUvBO_h0jTohBFG-unA/exec";
    let currentUser, couponData = {}, paginationState = {}; 
    let deleteInfo = {}, redeemInfo = {};
    const ITEMS_PER_PAGE = 10;
    
    let myCouponTypeModal, myPrizeModal, myConfirmDeleteModal, myConfirmRedeemModal, appToast;

    document.addEventListener('DOMContentLoaded', () => {
        const userJson = sessionStorage.getItem('currentUser');
        if (!userJson || JSON.parse(userJson).role !== 'guru') {
            window.location.href = 'index.html'; 
            return;
        }
        currentUser = JSON.parse(userJson);
        
        myCouponTypeModal = new bootstrap.Modal(document.getElementById('couponTypeModal'));
        myPrizeModal = new bootstrap.Modal(document.getElementById('prizeModal'));
        myConfirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        myConfirmRedeemModal = new bootstrap.Modal(document.getElementById('confirmRedeemModal'));
        appToast = new bootstrap.Toast(document.getElementById('appToast'));

        document.getElementById('teacherName').textContent = `Hai, ${currentUser.user.nama}!`;
        setupEventListeners();
        loadInitialData();
    });

    function setupEventListeners() {
        document.getElementById('logoutBtn').addEventListener('click', () => { sessionStorage.removeItem('currentUser'); window.location.href = 'index.html'; });
        document.getElementById('couponTypeForm').addEventListener('submit', handleAddForm);
        document.getElementById('prizeForm').addEventListener('submit', handleAddForm);
        document.getElementById('confirmDeleteBtn').addEventListener('click', executeDelete);
        document.getElementById('confirmRedeemBtn').addEventListener('click', executeRedeem);
        document.getElementById('studentSearchGive').addEventListener('input', debounce(() => filterStudentList('Give'), 300));
        document.getElementById('studentSearchRedeem').addEventListener('input', debounce(() => filterStudentList('Redeem'), 300));
        document.getElementById('historySearch').addEventListener('input', () => debouncedSearch('history'));
        
        document.getElementById('classFilter').addEventListener('change', () => {
            if (paginationState.classCoupon) {
                paginationState.classCoupon.currentPage = 1;
            }
            renderPaginatedView('classCoupon');
        });
    }

    async function loadInitialData() {
        showLoader(true);
        const data = await apiCall('getCouponManagementData');
        if (data) {
            couponData = data;
            paginationState = {
                history: { currentPage: 1 }, classCoupon: { currentPage: 1 },
                couponTypes: { currentPage: 1 }, prizes: { currentPage: 1 },
            };
            filterStudentList('Give');
            filterStudentList('Redeem');
            renderPerKelasTab();
            renderManagementTab();
            renderHistoryTab();
        }
        showLoader(false);
    }
    
    async function refreshData(activeStudentEmail = null, mode = null) {
        showLoader(true);
        const data = await apiCall('getCouponManagementData');
        if (data) {
            couponData = data;
            renderPerKelasTab();
            renderManagementTab();
            renderHistoryTab();
            
            if(activeStudentEmail && mode) {
                const activeStudent = couponData.students.find(s => s.email === activeStudentEmail);
                if (activeStudent) {
                    filterStudentList(mode); 
                    const listEl = document.getElementById(`studentList${mode}`);
                    const studentItem = Array.from(listEl.children).find(el => el.dataset.email === activeStudentEmail);
                    if (studentItem) {
                        studentItem.classList.add('active');
                    }
                    if (mode === 'Give') renderActionAreaGive(activeStudent);
                    if (mode === 'Redeem') renderActionAreaRedeem(activeStudent);
                }
            } else if (mode) {
                filterStudentList(mode);
            }
        }
        showLoader(false);
    }
    
    function filterStudentList(mode) {
        const searchTerm = document.getElementById(`studentSearch${mode}`).value.toLowerCase();
        const studentListEl = document.getElementById(`studentList${mode}`);
        studentListEl.innerHTML = '';
        if (couponData && couponData.students) {
            couponData.students
                .filter(s => s && s.nama && s.nama.toLowerCase().includes(searchTerm))
                .sort((a,b) => (a.nama || '').localeCompare(b.nama || ''))
                .forEach(student => {
                    const studentItem = document.createElement('a');
                    studentItem.href = '#';
                    studentItem.className = 'list-group-item list-group-item-action';
                    studentItem.textContent = `${student.nama} (${student.kelas})`;
                    studentItem.dataset.email = student.email;
                    studentItem.onclick = (e) => {
                        e.preventDefault();
                        studentListEl.querySelectorAll('.list-group-item-action').forEach(el => el.classList.remove('active'));
                        studentItem.classList.add('active');
                        if (mode === 'Give') renderActionAreaGive(student);
                        else renderActionAreaRedeem(student);
                    };
                    studentListEl.appendChild(studentItem);
                });
        }
    }

    function renderActionAreaGive(student) {
        const actionArea = document.getElementById('actionAreaGive');
        const balance = couponData.studentCoupons.filter(c => c.emailSiswa === student.email && c.status === 'Tersedia').length;

        let typesHtml = couponData.couponTypes && couponData.couponTypes.length > 0
            ? couponData.couponTypes.map(type => `<div class="col-12 mb-3"><div class="item-card-long"><div class="icon-container"><i class="fas fa-medal"></i></div><div class="content-container"><div><h6 class="item-title">${type.capaian}</h6><p class="item-description">${type.deskripsi || 'Tidak ada deskripsi.'}</p></div><div class="item-footer"><span class="fw-bold text-success">+${type.jumlahKupon} Kupon</span><button class="btn btn-sm btn-primary" onclick="giveCoupon(event, '${student.email}', '${type.idKuponTipe}', ${type.jumlahKupon})"><i class="fas fa-plus-circle"></i> Berikan</button></div></div></div></div>`).join('')
            : '<div class="col-12"><p class="text-muted text-center">Belum ada tipe kupon. Tambahkan di tab Manajemen.</p></div>';
        
        actionArea.innerHTML = `
            <div class="student-info-panel">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h5 class="fw-normal mb-0">Memberikan Kupon untuk <br><strong class="text-primary">${student.nama}</strong></h5></div>
                    <div class="text-end"><h5 class="fw-normal mb-0">Saldo Saat Ini</h5><h2 class="display-4 mb-0">${balance}</h2></div>
                </div>
            </div>
            <h5 class="mb-3 fw-bold">2. Pilih Capaian</h5>
            <div style="max-height: 450px; overflow-y: auto; padding-right: 15px;"><div class="row">${typesHtml}</div></div>`;
    }

    function renderActionAreaRedeem(student) {
        const actionArea = document.getElementById('actionAreaRedeem');
        const balance = couponData.studentCoupons.filter(c => c.emailSiswa === student.email && c.status === 'Tersedia').length;

        let prizesHtml = couponData.prizes && couponData.prizes.length > 0
            ? couponData.prizes.map(prize => {
                const canAfford = balance >= prize.kuponDibutuhkan;
                return `<div class="col-12 mb-3"><div class="item-card-long"><div class="icon-container"><i class="fas fa-gift"></i></div><div class="content-container"><div><h6 class="item-title">${prize.namaHadiah}</h6><p class="item-description">${prize.deskripsi || 'Tidak ada deskripsi.'}</p></div><div class="item-footer"><span class="item-cost">${prize.kuponDibutuhkan} <i class="fas fa-ticket-alt fa-sm"></i></span><button class="btn btn-primary btn-sm" onclick="showRedeemConfirmation('${student.email}', '${prize.idHadiah}', ${prize.kuponDibutuhkan}, '${student.nama}', '${prize.namaHadiah}')" ${canAfford ? '' : 'disabled'}><i class="fas fa-exchange-alt"></i> Tukar</button></div></div> ${!canAfford ? `<div class="disabled-overlay"><span>Kupon Tidak Cukup</span></div>` : ''}</div></div>`;
            }).join('')
            : '<div class="col-12"><p class="text-muted text-center">Belum ada hadiah tersedia. Tambahkan di tab Manajemen.</p></div>';

        actionArea.innerHTML = `
            <div class="student-info-panel">
                <div class="d-flex justify-content-between align-items-center">
                    <div><h5 class="fw-normal mb-0">Katalog Hadiah untuk <br><strong class="text-primary">${student.nama}</strong></h5></div>
                    <div class="text-end"><h5 class="fw-normal mb-0">Saldo Kupon</h5><h2 class="display-4 mb-0">${balance}</h2></div>
                </div>
            </div>
            <h5 class="mb-3 fw-bold">2. Pilih Hadiah</h5>
            <div style="max-height: 450px; overflow-y: auto; padding-right: 15px;"><div class="row">${prizesHtml}</div></div>`;
    }
    
    async function giveCoupon(event, studentEmail, couponTypeId, amount) {
        const button = event.target.closest('button');
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;

        const result = await apiCall('giveCoupons', {emailSiswa: studentEmail, idKuponTipe: couponTypeId, jumlah: amount});
        
        button.disabled = false;
        button.innerHTML = originalHtml;
        if (result) {
            showToast(`Berhasil memberikan ${amount} kupon!`, 'Sukses', 'success');
            await refreshData(studentEmail, 'Give');
        }
    }
    
    function showRedeemConfirmation(emailSiswa, idHadiah, kuponDibutuhkan, namaSiswa, namaHadiah) {
        redeemInfo = { emailSiswa, idHadiah, kuponDibutuhkan, namaSiswa, namaHadiah };
        document.getElementById('confirmRedeemBody').innerHTML = `Tukarkan <strong>${kuponDibutuhkan} kupon</strong> milik <strong>${namaSiswa}</strong> dengan hadiah <strong class="text-primary">${namaHadiah}</strong>?`;
        myConfirmRedeemModal.show();
    }

    async function executeRedeem() {
        myConfirmRedeemModal.hide();
        const result = await apiCall('redeemPrize', redeemInfo);
        if (result) {
            showToast('Hadiah berhasil ditukarkan!', 'Sukses', 'success');
            await refreshData(redeemInfo.emailSiswa, 'Redeem');
        }
    }
    
    async function executeDelete() {
        myConfirmDeleteModal.hide();
        const action = deleteInfo.type === 'couponType' ? 'deleteCouponType' : 'deletePrize';
        const result = await apiCall(action, { id: deleteInfo.id });
        if(result) {
            showToast('Data berhasil dihapus.', 'Berhasil', 'success');
            await loadInitialData();
        }
    }
    
    async function handleAddForm(e) {
        e.preventDefault();
        const form = e.target;
        const button = form.querySelector('button[type="submit"]');
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status"></span> Menyimpan...`;

        let action, payload, modal, successMsg;

        if (form.id === 'couponTypeForm') {
            action = 'addCouponType';
            payload = { capaian: document.getElementById('capaian').value, jumlahKupon: document.getElementById('jumlahKupon').value, deskripsi: document.getElementById('deskripsiKupon').value };
            modal = myCouponTypeModal;
            successMsg = 'Tipe kupon berhasil ditambahkan.';
        } else {
            action = 'addPrize';
            payload = { namaHadiah: document.getElementById('namaHadiah').value, kuponDibutuhkan: document.getElementById('kuponDibutuhkan').value, deskripsi: document.getElementById('deskripsiHadiah').value };
            modal = myPrizeModal;
            successMsg = 'Hadiah berhasil ditambahkan.';
        }

        const result = await apiCall(action, payload);
        
        button.disabled = false;
        button.innerHTML = originalHtml;

        if (result) {
            modal.hide();
            form.reset();
            showToast(successMsg, 'Berhasil', 'success');
            await loadInitialData();
        }
    }

    function confirmDelete(type, id, name) {
        document.getElementById('confirmMessageText').textContent = `Apakah Anda yakin ingin menghapus ${name}? Aksi ini tidak dapat dibatalkan.`;
        deleteInfo = { type, id };
        myConfirmDeleteModal.show();
    }
    
    const debouncedSearch = debounce((tableId) => {
        if (paginationState[tableId]) paginationState[tableId].currentPage = 1;
        renderPaginatedView(tableId);
    }, 300);

    function renderPaginatedView(key) {
        const state = paginationState[key];
        if (!state) return;

        let fullData = [];
        let renderFunction;

        switch (key) {
            case 'history':
                fullData = couponData.redemptionHistory || [];
                const searchTerm = document.getElementById('historySearch')?.value.toLowerCase() || '';
                if (searchTerm) {
                    fullData = fullData.filter(item => (item.namaSiswa || '').toLowerCase().includes(searchTerm) || (item.namaHadiah || '').toLowerCase().includes(searchTerm));
                }
                renderFunction = (data) => document.getElementById('historyTableBody').innerHTML = data.map(item => `<tr><td>${new Date(item.tanggalTukar).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</td><td>${item.namaSiswa}</td><td>${item.namaHadiah}</td><td class="text-center">${item.kuponDikeluarkan}</td></tr>`).join('') || `<tr><td colspan="4" class="text-center text-muted">Tidak ada riwayat.</td></tr>`;
                break;
            case 'classCoupon':
                const selectedClass = document.getElementById('classFilter').value;
                const studentsToDisplay = (selectedClass === 'all' || !selectedClass ? couponData.students : couponData.students.filter(s => s && s.kelas === selectedClass)) || [];
                fullData = studentsToDisplay.map(student => ({ ...student, balance: couponData.studentCoupons.filter(c => c.emailSiswa === student.email && c.status === 'Tersedia').length })).sort((a,b) => b.balance - a.balance);
                renderFunction = (data) => document.getElementById('classCouponTable').innerHTML = data.map((student, index) => `<tr><td>${(state.currentPage - 1) * ITEMS_PER_PAGE + index + 1}</td><td>${student.nama}</td><td>${student.kelas}</td><td class="text-center"><span class="badge bg-primary rounded-pill fs-6">${student.balance}</span></td></tr>`).join('') || `<tr><td colspan="4" class="text-center text-muted">Tidak ada siswa di kelas ini.</td></tr>`;
                break;
            case 'couponTypes':
                fullData = couponData.couponTypes || [];
                renderFunction = (data) => document.getElementById('couponTypesTable').innerHTML = data.map(c => `<tr><td>${c.capaian}</td><td>${c.jumlahKupon}</td><td><button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('couponType', '${c.idKuponTipe}', 'tipe kupon: ${c.capaian}')"><i class="fas fa-trash"></i></button></td></tr>`).join('') || `<tr><td colspan="3" class="text-center text-muted">Belum ada data.</td></tr>`;
                break;
            case 'prizes':
                fullData = couponData.prizes || [];
                renderFunction = (data) => document.getElementById('prizesTable').innerHTML = data.map(p => `<tr><td>${p.namaHadiah}</td><td>${p.kuponDibutuhkan}</td><td><button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('prize', '${p.idHadiah}', 'hadiah: ${p.namaHadiah}')"><i class="fas fa-trash"></i></button></td></tr>`).join('') || `<tr><td colspan="3" class="text-center text-muted">Belum ada data.</td></tr>`;
                break;
        }

        const totalPages = Math.ceil(fullData.length / ITEMS_PER_PAGE);
        state.currentPage = Math.max(1, Math.min(state.currentPage, totalPages));
        const paginatedData = fullData.slice((state.currentPage - 1) * ITEMS_PER_PAGE, state.currentPage * ITEMS_PER_PAGE);

        renderFunction(paginatedData);
        
        const paginationContainer = document.getElementById(`${key}Pagination`);
        if (paginationContainer) {
            paginationContainer.innerHTML = generatePaginationControls(key, state.currentPage, totalPages);
        }
    }
    
    function generatePaginationControls(key, currentPage, totalPages) {
        if (totalPages <= 1) return '';
        let html = '<ul class="pagination pagination-sm">';
        html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="event.preventDefault(); changePage('${key}', ${currentPage - 1})">«</a></li>`;
        
        const maxPagesToShow = 5;
        let startPage, endPage;
        if (totalPages <= maxPagesToShow) {
            startPage = 1;
            endPage = totalPages;
        } else {
            const maxPagesBeforeCurrent = Math.floor(maxPagesToShow / 2);
            const maxPagesAfterCurrent = Math.ceil(maxPagesToShow / 2) - 1;
            if (currentPage <= maxPagesBeforeCurrent) {
                startPage = 1;
                endPage = maxPagesToShow;
            } else if (currentPage + maxPagesAfterCurrent >= totalPages) {
                startPage = totalPages - maxPagesToShow + 1;
                endPage = totalPages;
            } else {
                startPage = currentPage - maxPagesBeforeCurrent;
                endPage = currentPage + maxPagesAfterCurrent;
            }
        }
        if (startPage > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); changePage('${key}', 1)">1</a></li>`;
            if (startPage > 2) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        for (let i = startPage; i <= endPage; i++) { html += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="event.preventDefault(); changePage('${key}', ${i})">${i}</a></li>`; }
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            html += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); changePage('${key}', ${totalPages})">${totalPages}</a></li>`;
        }

        html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="event.preventDefault(); changePage('${key}', ${currentPage + 1})">»</a></li>`;
        html += '</ul>';
        return html;
    }

    function changePage(key, page) {
        if (paginationState[key] && page > 0) {
            const state = paginationState[key];
            let fullData;
            if (key === 'classCoupon') {
                 const selectedClass = document.getElementById('classFilter').value;
                 fullData = (selectedClass === 'all' || !selectedClass ? couponData.students : couponData.students.filter(s => s && s.kelas === selectedClass)) || [];
            } else if (key === 'history') {
                fullData = couponData.redemptionHistory || [];
            } else {
                fullData = couponData[key] || [];
            }
            const totalPages = Math.ceil(fullData.length / ITEMS_PER_PAGE);

            if (page <= totalPages) {
                state.currentPage = page;
                renderPaginatedView(key);
            }
        }
    }
    
    function renderPerKelasTab() {
        const classFilter = document.getElementById('classFilter');
        if (classFilter.options.length <= 1 && couponData && couponData.classes) {
            classFilter.innerHTML = '<option value="all">Semua Kelas</option>';
            couponData.classes.sort().forEach(c => { if(c) classFilter.innerHTML += `<option value="${c}">${c}</option>`; });
        }
        renderPaginatedView('classCoupon');
    }

    function renderManagementTab() { renderPaginatedView('couponTypes'); renderPaginatedView('prizes'); }
    function renderHistoryTab() { renderPaginatedView('history'); }

    function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
    function showLoader(isLoading) {
        document.getElementById('loader').style.display = isLoading ? 'flex' : 'none';
    }
    
    async function apiCall(action, data = {}) {
        showLoader(true);
        try {
            const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, data }), redirect: "follow" });
            const result = await response.json();
            if (result.status === 'success') {
                showLoader(false);
                return result.data;
            } else {
                 throw new Error(result.message || 'Terjadi kesalahan server.');
            }
        } catch (error) {
            console.error("API Call Error:", error);
            showLoader(false);
            showToast("Error: " + error.message, 'Gagal', 'danger');
            return null;
        }
    }

    function showToast(message, title = 'Notifikasi', type = 'success') {
        const toastEl = document.getElementById('appToast');
        const titleEl = document.getElementById('toastTitle');
        const bodyEl = document.getElementById('toastBody');
        const iconEl = toastEl.querySelector('.toast-header i');
        const headerEl = toastEl.querySelector('.toast-header');
        const closeBtn = toastEl.querySelector('.btn-close');
        headerEl.classList.remove('bg-success', 'bg-danger', 'text-white');
        closeBtn.classList.remove('btn-close-white');
        iconEl.classList.remove('fa-check-circle', 'fa-times-circle');

        if(type === 'success') {
            headerEl.classList.add('bg-success', 'text-white');
            closeBtn.classList.add('btn-close-white');
            iconEl.classList.add('fa-check-circle');
        } else {
            headerEl.classList.add('bg-danger', 'text-white');
            closeBtn.classList.add('btn-close-white');
            iconEl.classList.add('fa-times-circle');
        }
        
        titleEl.textContent = title;
        bodyEl.textContent = message;
        appToast.show();
    }
</script>
</body>
</html>